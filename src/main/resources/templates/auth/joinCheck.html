<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/styles.css}" >
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welcome to Chats</title>
</head>
<body>
<input type="hidden" id="token" th:value="${session.token}"/>
<input type="hidden" id="userId" th:value="${session.users.userId}"/>

<header class="welcome-header">
    <h1 class="welcome-header__title">본인인증</h1>
    <p class="welcome-header__text">
        push 알림으로 간 인증번호 6자리를 입력해주세요.
    </p>
</header>

<form id="login-form" action="friends.html" method="get">
    <input id="serialNo" name="serialNo" type="number" placeholder="인증번호를 입력해주세요." maxlength="6" />
    <input type="button" value="확인" onclick="checkSerialNo()" />
    <input type="button" value="인증번호 재발송" onclick="pushSend()" />
</form>

<script
        src="https://kit.fontawesome.com/6478f529f2.js"
        crossorigin="anonymous"
></script>
</body>
</html>

<script th:inline="javascript">
    $("#joinHeader").remove();
    pushSend();

    //푸시발송
    function pushSend(){
        var serialNo = generateRandomCode(6);
        var title = "인증번호는 " + serialNo+ " 입니다.";
        var body = "인증번호는 " + serialNo +" 입니다. 입력란에 인증번호를 입력해주세요.";

        var params = {
             title : title
            ,body : body
            ,token : $("#token").val()
        }

        console.log(params);
        $.ajax({
	         type : 'POST'
	        ,url : "/pushSend"
	        ,dataType : 'json'
	        ,data : JSON.stringify(params)
	        ,contentType: 'application/json'
	        ,success : function(result) {
				alert("푸시가 정상적으로 전송되었습니다.");
                saveSerialNo(serialNo);
	        },
	        error: function(request, status, error) {

	        }
	    })
    }

    //랜덤으로 인증번호 만들기
    function generateRandomCode(n) {
        let str = ''
        for (let i = 0; i < n; i++) {
            str += Math.floor(Math.random() * 10)
        }
        return str
    }

    //시리얼 넘버 저장
    function saveSerialNo(serialNo){

        var params = {
             serialNo : serialNo
             ,userId : $("#userId").val()
        }

        console.log(params);
        $.ajax({
	         type : 'POST'
	        ,url : "/saveSerialNo"
	        ,dataType : 'json'
	        ,data : JSON.stringify(params)
	        ,contentType: 'application/json'
	        ,success : function(result) {

	        },
	        error: function(request, status, error) {

	        }
	    })
    }

    //인증번호 체크크
   function checkSerialNo(){

        var serialNo = $("#serialNo").val();

        var params = {
             serialNo : serialNo
            ,userId : $("#userId").val()
        }

        console.log(params);
        $.ajax({
	         type : 'POST'
	        ,url : "/serialNoCheck"
	        ,dataType : 'json'
	        ,data : JSON.stringify(params)
	        ,contentType: 'application/json'
	        ,success : function(result) {
	            alert(result.resultMsg);

	            if(result.resultCode == 'success'){
                    location.href = "/";
	            }

	        },
	        error: function(request, status, error) {

	        }
	    })

    }

</script>
